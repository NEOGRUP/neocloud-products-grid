<!--
@license
Copyright (c) 2017 Neo
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../iron-list/iron-list.html">

<link rel="import" href="neocloud-products-grid-item.html">

<dom-module id="neocloud-products-grid">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      iron-list {
        flex: 1 1 auto;
      }
    </style>

    <iron-list grid>
      <template>
        <neocloud-products-grid-item
                item="[[item]]"
                on-parent-folder-selected="_parentFolderSelected"
                on-next-button-pressed="_nextButtonPressed"
                on-previous-button-pressed="_previousButtonPressed"
                on-folder-selected="_folderSelected"
                on-product-selected="_productSelected">
        </neocloud-products-grid-item>
      </template>
    </iron-list>

  </template>

  <script>
    Polymer({
      is: 'neocloud-products-grid',

      behaviors: [
        Polymer.AppLocalizeBehavior
      ],

      properties: {
        data: {
          type: Object,
          value: [],
          observer: '_dataChanged'
        },
        language: String,
        urlTranslate:{
          type: String
        },
        
        /**
         * All folder and products
         */
        levels: {
          type: Array,
          value: []
        },
        level: {
          type: Array,
          value: []
        },
        currentLevel: {
          type: Number,
          value: 0
        },
        levelIndexFrom: {
          type: Number,
          value: 0
        },
        levelIndexTo: {
          type: Number,
          value: 0
        },
        currentLevelIndex: {
          type: Number,
          value: 0
        },
        currentLevelPage: {
          type: Number,
          value: 0
        },
        limitProductsPerLevel: {
          type: Number,
          value: 5
        },
        showParentFolder: {
          type: Boolean,
          value: false
        },
        parentFolder: {
          type: Object,
          value: {
            backgroundColor: "pink",
            code: "",
            name: "...",
            type: "parentFolder",
            urlImage: ""
          }
        },
        showNextButton: {
          type: Boolean,
          value: false
        },
        nextButton: {
          type: Object,
          value: {
            backgroundColor: "yellow",
            code: "",
            name: "Siguiente",
            type: "nextButton",
            urlImage: ""
          }
        },
        showPreviousButton: {
          type: Boolean,
          value: false
        },
        previousButton: {
          type: Object,
          value: {
            backgroundColor: "yellow",
            code: "",
            name: "Anterior",
            type: "previousButton",
            urlImage: ""
          }
        },

      },

      _dataChanged: function(){
        /* TODO: Calculate limitProductsPerLevel */
        this.currentLevel = 0;
        this.currentLevelPage = 0;
        this.levelIndexFrom = 0;
        if (this.data.length > 0){
          this.levels.push(this.data);
          if (this.limitProductsPerLevel != 0 ) {
            if (this.levels[this.currentLevel].length > this.limitProductsPerLevel) {
              this.levelIndexTo = this.levelIndexTo + this.limitProductsPerLevel - 1 - 1;
              this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
              this.level.push(this.nextButton);
            } else{
              this.levelIndexTo = this.levels[this.currentLevel].length - 1;
              this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
            }
          }
          else {
            this.level = this.levels[this.currentLevel];

          }
          this.$$('iron-list').items = this.level;
        }
        console.log('level: ' + this.currentLevel + ' pageLevel: ' + this.currentLevelPage + ' Items: '+this.levelIndexFrom+' - '+this.levelIndexTo);
      },


      _parentFolderSelected: function(){
        this.currentLevel--;
        this.currentLevelPage = 0;
        this.levelIndexFrom = 0;
        // Remove the last element of an array:
        this.levels.pop();

        if (this.limitProductsPerLevel != 0 ) {
          if (this.levels[this.currentLevel].length > this.limitProductsPerLevel) {
            this.levelIndexTo = this.levelIndexFrom + this.limitProductsPerLevel - 1 - 1;
            this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
            this.level.push(this.nextButton);
          } else{
            this.levelIndexTo = this.levels[this.currentLevel].length - 1;
            this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
          }
        }
        else{
          this.level =  this.levels[this.currentLevel];
        }

        if (this.currentLevel > 0){
          this.level.unshift(this.parentFolder);
          this.showParentFolder = true;
        }
        this.$$('iron-list').items = this.level;
      },


      _nextButtonPressed: function(){
        this.currentLevelPage++;
        this.levelIndexFrom = this.levelIndexTo + 1;
        this.showNextButton = false;
        this.showParentFolder = false;
        this.showPreviousButton = true;

        if ( this.levels[this.currentLevel].length - this.levelIndexFrom <= this.limitProductsPerLevel - 1){ //-1 del previous //ulyima pÃ¡gina
          this.levelIndexTo = this.levels[this.currentLevel].length - 1;
        } else { //necesario next
          this.levelIndexTo = this.levelIndexFrom + this.limitProductsPerLevel - 1 - 1 - 1; //-1 previous -1 next -1 0based
          this.showNextButton = true;
        }

        console.log('level: ' + this.currentLevel + ' pageLevel: ' + this.currentLevelPage + ' Items: '+this.levelIndexFrom+' - '+this.levelIndexTo);

        this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
        this.level.unshift(this.previousButton);
        if (this.showNextButton) {
          this.level.push(this.nextButton);
        }
        this.$$('iron-list').items = this.level;

      },



      _previousButtonPressed: function(){
        this.currentLevelPage--;
        this.levelIndexTo = this.levelIndexFrom - 1;
        this.showNextButton = true;
        this.showParentFolder = false;
        this.showPreviousButton = false;

        if (this.currentLevelPage>0){
          this.showPreviousButton = true;
        } else {
          if (this.currentLevel>0) {
            this.showParentFolder = true;
          }
        }

        if ( this.showParentFolder || this.showPreviousButton){
          this.levelIndexFrom = this.levelIndexTo - (this.limitProductsPerLevel - 2) + 1; //-2 per parent/previous i next, +1 0 based
          if (this.levelIndexFrom<0) this.levelIndexFrom = 0;
        } else { //necesario next
          this.levelIndexFrom = 0;
        }

        console.log('level: ' + this.currentLevel + ' pageLevel: ' + this.currentLevelPage + ' Items: '+this.levelIndexFrom+' - '+this.levelIndexTo);

        this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
        if (this.showPreviousButton) {
          this.level.unshift(this.previousButton);
        }
        if (this.showParentFolder) {
          this.level.unshift(this.parentFolder);
        }
        if (this.showNextButton) {
          this.level.push(this.nextButton);
        }
        this.$$('iron-list').items = this.level;
      },


      _folderSelected: function(item){
        this.currentLevel++;
        this.currentLevelPage = 0;
        this.levelIndexFrom = 0;
        this.levels.push(item.detail.content);

        if (this.limitProductsPerLevel != 0 ) {

          if (this.levels[this.currentLevel].length > this.limitProductsPerLevel - 1) {
            this.levelIndexTo = this.limitProductsPerLevel - 1 - 1 - 1; //-1 de 0 based --1 paremnt folder -1 next
            console.log(this.levelIndexTo);
            this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1); //+1 de operativa slice
            this.level.push(this.nextButton);
          } else{
            this.levelIndexTo = this.levels[this.currentLevel].length - 1;
            this.level = this.levels[this.currentLevel].slice(this.levelIndexFrom, this.levelIndexTo + 1);
          }
        }
        else{
          this.level =  this.levels[this.currentLevel];
        }
        this.level.unshift(this.parentFolder);
        this.$$('iron-list').items = this.level;
        console.log('level: ' + this.currentLevel + ' pageLevel: ' + this.currentLevelPage + ' Items: '+this.levelIndexFrom+' - '+this.levelIndexTo);
      },

      _productSelected: function(item){
        console.log(item.detail);
      },


    });


  </script>
</dom-module>